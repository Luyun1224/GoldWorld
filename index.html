<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>財務儀表板分析</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ECharts for interactive charts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 使用 Inter 字體作為主要英文字體，Noto Sans TC 作為中文後備字體 */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #0d1117; /* 更深的背景色 */
        }
        /* 自訂 ECharts Tooltip 樣式 */
        .echarts-tooltip {
            padding: 12px !important;
            background-color: rgba(20, 25, 38, 0.9) !important;
            border: 1px solid #374151 !important;
            border-radius: 8px !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4) !important;
            color: #f9fafb !important;
        }
    </style>
</head>
<body class="text-gray-200">

    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-white text-center">金世界公寓大廈 財務報表分析</h1>
            <p class="text-center text-gray-400 mt-2">期間：114年2月 - 114年6月 (註：缺少5月份資料)</p>
        </header>

        <!-- Stat Cards -->
        <div id="stat-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Stat cards will be injected by JavaScript -->
        </div>

        <!-- Main Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="bg-gray-900 p-6 rounded-2xl shadow-lg">
                <h2 class="text-xl font-bold mb-4 text-white">每月收支比較</h2>
                <div id="bar-chart" class="w-full h-[300px]"></div>
            </div>
            <div class="bg-gray-900 p-6 rounded-2xl shadow-lg">
                <h2 class="text-xl font-bold mb-4 text-white">總結餘趨勢</h2>
                <div id="line-chart" class="w-full h-[300px]"></div>
            </div>
        </div>
        
        <!-- AI Financial Advisor -->
        <div id="financial-advisor" class="my-12">
            <!-- Advisor content will be injected by JavaScript -->
        </div>

        <!-- Detailed Analysis Section -->
        <div class="my-10">
            <h2 class="text-2xl font-bold text-center mb-2 text-white">收支結構分析</h2>
            <p class="text-center text-gray-400 mb-6">請選擇月份以查看詳細的收支結構與前期比較</p>
            <div id="month-selector" class="flex justify-center flex-wrap gap-2 mb-8">
                <!-- Month buttons will be injected by JavaScript -->
            </div>
            <div id="details-view" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Pie charts and tables will be injected here -->
            </div>
        </div>
        
        <footer class="text-center mt-8 text-xs text-gray-500">
            <p>此報表由 Gemini 基於您提供的圖片生成。</p>
            <p>數據僅供參考，所有金額以原始財務報表為準。</p>
        </footer>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- 資料區塊 ---
    const financialData = [
        { month: '114年2月', income: 144669, expense: 196523, balance: 608928, incomeDetails: [{ name: '管理費', value: 71787 }, { name: '基地台收入', value: 36000 },{ name: '車管費', value: 14400 }, { name: '網路費收入', value: 3000 },{ name: '定存利息', value: 1532 }, { name: '磁扣', value: 150 },], expenseDetails: [{ name: '物業管理費', value: 104000 }, { name: '維修工程款', value: 20300 },{ name: '電費', value: 17011 }, { name: '清潔員薪資', value: 10500 },{ name: '出席費', value: 10000 }, { name: '電梯維護', value: 6000 },{ name: '消防維護', value: 4000 }, { name: '行政雜支', value: 3612 },{ name: '監視器維護', value: 2500 }, { name: '垃圾清運', value: 2800 },{ name: '網路費支出', value: 800 },],},
        { month: '114年3月', income: 249297, expense: 224959, balance: 633266, incomeDetails: [{ name: '管理費', value: 120500 }, { name: '基地台收入', value: 36000 },{ name: '車管費', value: 21860 }, { name: '廣告費', value: 18000 },{ name: '網路費收入', value: 5400 }, { name: '定存利息', value: 1532 },{ name: '磁扣', value: 150 },], expenseDetails: [{ name: '物業管理費', value: 104000 }, { name: '防水工程', value: 37000 },{ name: '電費', value: 15792 }, { name: '清潔員薪資', value: 10500 },{ name: '電梯維護', value: 6000 }, { name: '消防維護', value: 4000 },{ name: '機械車位維護', value: 3150 }, { name: '行政雜支', value: 3917 },{ name: '監視器維護', value: 2500 }, { name: '網路費支出', value: 800 },{ name: '估價師費', value: 502 },],},
        { month: '114年4月', income: 171343, expense: 165778, balance: 638831, incomeDetails: [{ name: '管理費', value: 132456 }, { name: '基地台收入', value: 18000 },{ name: '車管費', value: 10800 }, { name: '定存利息', value: 532 },], expenseDetails: [{ name: '物業管理費', value: 104000 }, { name: '電費', value: 15182 },{ name: '管委會用品', value: 9555 }, { name: '清潔員薪資', value: 10500 },{ name: '電梯維護', value: 6000 }, { name: '消防維護', value: 4000 },{ name: '行政雜支', value: 3686 }, { name: '監視器維護', value: 2500 },{ name: '網路費支出', value: 800 },],},
        { month: '114年5月', income: null, expense: null, balance: null, incomeDetails: [], expenseDetails: [],},
        { month: '114年6月', income: 233894, expense: 261597, balance: 613663, incomeDetails: [{ name: '管理費', value: 116895 }, { name: '基地台收入', value: 36000 },{ name: '車管費', value: 10800 }, { name: '廣告費', value: 18000 },{ name: '銀行利息', value: 2117 }, { name: '磁扣', value: 50 },], expenseDetails: [{ name: '物業管理費', value: 107000 }, { name: '回收場修繕', value: 45700 },{ name: '電費', value: 16324 }, { name: '清潔員薪資', value: 10500 },{ name: '端午節禮金', value: 8000 }, { name: '電梯維護', value: 6000 },{ name: '消防維護', value: 4000 }, { name: '行政雜支', value: 3694 },{ name: '監視器維護', value: 2500 }, { name: '物業費差額', value: 3000 },{ name: '公共意外險', value: 2779 }, { name: '電眼更新', value: 2800 },{ name: '網路費支出', value: 800 },],},
    ];
    const COLORS = ['#5470C6', '#91CC75', '#FAC858', '#EE6666', '#73C0DE', '#3BA272', '#FC8452', '#9A60B4', '#EA7CCC'];
    const validData = financialData.filter(d => d.balance !== null);
    let selectedMonth = validData.slice(-1)[0].month;

    // --- DOM 元素 ---
    const statCardsContainer = document.getElementById('stat-cards-container');
    const monthSelector = document.getElementById('month-selector');
    const detailsView = document.getElementById('details-view');
    const advisorContainer = document.getElementById('financial-advisor');

    // --- 輔助函式 ---
    const formatCurrency = (value) => {
        if (value === null || value === undefined) return 'N/A';
        return `$${new Intl.NumberFormat('zh-TW').format(value)}`;
    };

    // --- 渲染函式 ---

    function renderStatCards() {
        const latestData = validData.slice(-1)[0];
        const previousData = validData.slice(-2)[0];
        const balanceChange = latestData.balance - previousData.balance;
        const totalIncome = validData.reduce((acc, cur) => acc + (cur.income || 0), 0);
        const totalExpense = validData.reduce((acc, cur) => acc + (cur.expense || 0), 0);
        const netBalance = totalIncome - totalExpense;

        const cards = [
            { title: `最新總結餘 (${latestData.month.replace('114年', '')})`, value: formatCurrency(latestData.balance), change: `${balanceChange >= 0 ? '▲' : '▼'} ${formatCurrency(Math.abs(balanceChange))} vs ${previousData.month.replace('114年', '')}`, changeType: balanceChange >= 0 ? 'increase' : 'decrease', icon: '💰' },
            { title: '期間總收入', value: formatCurrency(totalIncome), changeType: 'increase', icon: '📈' },
            { title: '期間總支出', value: formatCurrency(totalExpense), changeType: 'decrease', icon: '📉' },
            { title: '期間淨結餘', value: formatCurrency(netBalance), changeType: netBalance >= 0 ? 'increase' : 'decrease', icon: '⚖️' }
        ];

        statCardsContainer.innerHTML = cards.map(card => `
            <div class="bg-gray-900 p-6 rounded-2xl shadow-lg flex items-center justify-between transition-transform transform hover:scale-105">
                <div>
                    <p class="text-sm font-medium text-gray-400">${card.title}</p>
                    <p class="text-2xl sm:text-3xl font-bold text-white">${card.value}</p>
                    ${card.change ? `<p class="text-xs mt-1 ${card.changeType === 'increase' ? 'text-green-400' : 'text-red-400'}">${card.change}</p>` : ''}
                </div>
                <div class="text-3xl p-3 rounded-full ${card.changeType === 'increase' ? 'bg-green-900/50 text-green-400' : 'bg-red-900/50 text-red-400'}">
                    ${card.icon}
                </div>
            </div>
        `).join('');
    }

    function renderMainCharts() {
        const barChart = echarts.init(document.getElementById('bar-chart'));
        const lineChart = echarts.init(document.getElementById('line-chart'));
        const axisLabelColor = '#9ca3af';

        const barOptions = {
            tooltip: { trigger: 'axis', triggerOn: 'click', backgroundColor: 'rgba(20, 25, 38, 0.9)', borderColor: '#374151', textStyle: { color: '#f9fafb' } },
            legend: { data: ['總收入', '總支出'], textStyle: { color: axisLabelColor } },
            grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
            xAxis: { type: 'category', data: validData.map(d => d.month), axisLine: { lineStyle: { color: axisLabelColor } } },
            yAxis: { type: 'value', axisLabel: { formatter: '{value}', color: axisLabelColor }, splitLine: { lineStyle: { type: 'dashed', color: '#374151' } } },
            series: [
                { name: '總收入', type: 'bar', data: validData.map(d => d.income), itemStyle: { color: '#4ade80' }, barWidth: '30%', radius: [4, 4, 0, 0] },
                { name: '總支出', type: 'bar', data: validData.map(d => d.expense), itemStyle: { color: '#f87171' }, barWidth: '30%', radius: [4, 4, 0, 0] }
            ]
        };

        const lineOptions = {
            tooltip: { trigger: 'axis', triggerOn: 'click', backgroundColor: 'rgba(20, 25, 38, 0.9)', borderColor: '#374151', textStyle: { color: '#f9fafb' } },
            legend: { data: ['總結餘'], textStyle: { color: axisLabelColor } },
            grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
            xAxis: { type: 'category', data: financialData.map(d => d.month), axisLine: { lineStyle: { color: axisLabelColor } } },
            yAxis: { type: 'value', axisLabel: { formatter: '{value}', color: axisLabelColor }, splitLine: { lineStyle: { type: 'dashed', color: '#374151' } } },
            series: [{ name: '總結餘', type: 'line', data: financialData.map(d => d.balance), smooth: true, connectNulls: true, itemStyle: { color: '#38bdf8' }, lineStyle: { width: 3 }, emphasis: { focus: 'series' } }]
        };

        barChart.setOption(barOptions);
        lineChart.setOption(lineOptions);

        window.addEventListener('resize', () => {
            barChart.resize();
            lineChart.resize();
        });
    }

    function renderAdvisor() {
        advisorContainer.innerHTML = `
            <h2 class="text-3xl font-bold text-center mb-2 text-white">
                <span class="text-cyan-400">AI 財務長</span> 決策建議
            </h2>
            <p class="text-center text-gray-400 mb-8">基於 114年2月-6月 財務數據之分析與策略建議</p>
            <div class="bg-gray-900 p-8 rounded-2xl shadow-lg">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-bold mb-4 text-cyan-400 border-b-2 border-cyan-800 pb-2">財務總評</h3>
                        <p class="text-gray-300 mb-6">本大樓整體財務狀況尚屬穩健，備用金維持在 $600,000 以上水平，足以應付日常營運。然而，<strong class="text-amber-400">收入來源相對單一，且易受大型、非預期性維修支出影響</strong>，導致單月現金流出現較大赤字，需建立更強的財務韌性。</p>
                        <h3 class="text-xl font-bold mb-4 text-red-400 border-b-2 border-red-800 pb-2">潛在問題與風險</h3>
                        <ul class="space-y-3 list-disc list-inside text-gray-300">
                            <li><strong class="text-red-400">缺乏資本利得帳戶：</strong>重大修繕（如防水、外牆）直接由管理費帳戶支出，嚴重衝擊當月財務。6月份的「回收場修繕」($45,700) 即為一例，這類支出若頻繁發生將快速消耗結餘。</li>
                            <li><strong class="text-red-400">支出審核機制不明：</strong>部分支出項目如「行政雜支」、「管委會用品」($9,555) 金額偏高且名目籠統，可能存在浪費或未經妥善議價的空間。</li>
                            <li><strong class="text-red-400">合約依賴度高：</strong>物業管理費佔總支出極高比例，若服務品質與價格不符，將成為最大財務負擔。</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold mb-4 text-green-400 border-b-2 border-green-800 pb-2">具體行動建議</h3>
                        <div class="space-y-4">
                            <div>
                                <h4 class="font-semibold text-gray-100">🎯 支出優化 (Cost Down)</h4>
                                <ul class="text-sm list-disc list-inside text-gray-300 pl-2">
                                    <li><strong>檢討非必要支出：</strong>建議重新評估「出席費」($10,000) 及「端午節禮金」($8,000) 的發放標準與金額，此類非固定支出應視當年度財務狀況彈性調整。</li>
                                    <li><strong>細化雜項支出：</strong>要求「行政雜支」需逐項列報，找出可節省項目（如改用電子通知減少紙張、文具統一採購等）。</li>
                                    <li><strong>重新議價或招標：</strong>針對「物業管理」、「電梯維護」等長期合約，建議每2-3年重新評估市場行情並公開招標。</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-100">📈 收入開源 (Revenue Up)</h4>
                                <ul class="text-sm list-disc list-inside text-gray-300 pl-2">
                                    <li><strong>活化公共空間：</strong>評估將會議室、頂樓平台等閒置空間，在不影響住戶安寧的前提下，短租給外部單位（如瑜珈課、手作坊）的可能性。</li>
                                    <li><strong>擴大廣告版位：</strong>除了現有廣告收入，可評估電梯內、公佈欄等空間增加廣告版位的可行性，爭取更多元的廣告來源。</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-100">🏦 長期策略 (Long-term Strategy)</h4>
                                <ul class="text-sm list-disc list-inside text-gray-300 pl-2">
                                    <li><strong>成立「公共基金」或「修繕基金」：</strong>此為最重要建議。應立即規劃從管理費提撥一定比例（如5%-10%）至獨立的修繕基金帳戶，專款專用。</li>
                                    <li><strong>推動節能措施：</strong>公共電費是重大開銷，建議研究將公共區域照明更換為LED燈具、加裝定時器等方案，長期來看能節省可觀費用。</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
    }

    function renderMonthSelector() {
        monthSelector.innerHTML = validData.map(item => `
            <button data-month="${item.month}" class="month-btn px-4 py-2 rounded-full text-sm font-semibold transition-colors ${selectedMonth === item.month ? 'bg-cyan-500 text-white shadow-md' : 'bg-gray-800 text-gray-300 hover:bg-gray-700'}">
                ${item.month}
            </button>
        `).join('');

        monthSelector.addEventListener('click', function(e) {
            if (e.target.classList.contains('month-btn')) {
                selectedMonth = e.target.dataset.month;
                renderDetailsView();
            }
        });
    }

    function renderDetailsView() {
        // Update button styles
        document.querySelectorAll('.month-btn').forEach(btn => {
            btn.classList.toggle('bg-cyan-500', btn.dataset.month === selectedMonth);
            btn.classList.toggle('text-white', btn.dataset.month === selectedMonth);
            btn.classList.toggle('bg-gray-800', btn.dataset.month !== selectedMonth);
            btn.classList.toggle('text-gray-300', btn.dataset.month !== selectedMonth);
        });

        const selectedIndex = financialData.findIndex(d => d.month === selectedMonth);
        const currentData = financialData[selectedIndex];
        
        let comparisonData = null;
        if (selectedIndex > 0) {
            for (let i = selectedIndex - 1; i >= 0; i--) {
                if (financialData[i].balance !== null) {
                    comparisonData = financialData[i];
                    break;
                }
            }
        }

        detailsView.innerHTML = `
            ${createPieChartHTML('income', currentData, comparisonData)}
            ${createPieChartHTML('expense', currentData, comparisonData)}
        `;
        
        createPieChart('income', currentData);
        createPieChart('expense', currentData);
    }
    
    function createPieChartHTML(type, currentData, comparisonData) {
        const title = type === 'income' ? '收入佔比' : '支出佔比';
        const details = type === 'income' ? currentData.incomeDetails : currentData.expenseDetails;
        const comparisonDetails = comparisonData ? (type === 'income' ? comparisonData.incomeDetails : comparisonData.expenseDetails) : null;
        const comparisonMonthName = comparisonData ? comparisonData.month.replace('114年', '') : null;

        const sortedDetails = [...details].sort((a, b) => b.value - a.value);

        const tableRows = sortedDetails.map((entry, index) => {
            const prevItem = comparisonDetails ? comparisonDetails.find(p => p.name === entry.name) : null;
            const prevValue = prevItem ? prevItem.value : 0;
            const change = entry.value - prevValue;
            let changeHTML = '';

            if (comparisonDetails) {
                if (prevValue === 0 && change > 0) {
                    changeHTML = `<span class="text-cyan-400">新增</span>`;
                } else if (change !== 0) {
                    const color = change > 0 ? 'text-red-400' : 'text-green-400';
                    const arrow = change > 0 ? '▲' : '▼';
                    changeHTML = `<span class="${color}">${arrow} ${formatCurrency(Math.abs(change))}</span>`;
                } else {
                    changeHTML = `<span class="text-gray-500">-</span>`;
                }
            }

            return `
                <tr class="border-b border-gray-700 last:border-b-0">
                    <td class="p-2 flex items-center"><span class="w-3 h-3 rounded-full mr-2 shrink-0" style="background-color: ${COLORS[index % COLORS.length]}"></span>${entry.name}</td>
                    <td class="p-2 text-right font-mono">${formatCurrency(entry.value)}</td>
                    ${comparisonDetails ? `<td class="p-2 text-right font-mono text-xs">${changeHTML}</td>` : ''}
                </tr>
            `;
        }).join('');

        return `
            <div class="bg-gray-900 p-6 rounded-2xl shadow-lg">
                <h3 class="text-xl font-bold mb-4 text-white">${currentData.month} ${title}</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                    <div id="${type}-pie-chart" class="w-full h-[300px]"></div>
                    <div class="overflow-y-auto max-h-[300px]">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="text-left text-xs text-gray-400">
                                    <th class="p-2 font-normal">項目</th>
                                    <th class="p-2 font-normal text-right">金額</th>
                                    ${comparisonDetails ? `<th class="p-2 font-normal text-right">與 ${comparisonMonthName} 比較</th>` : ''}
                                </tr>
                            </thead>
                            <tbody>${tableRows}</tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }

    function createPieChart(type, currentData) {
        const chartDom = document.getElementById(`${type}-pie-chart`);
        if (!chartDom) return;

        const pieChart = echarts.init(chartDom);
        const details = type === 'income' ? currentData.incomeDetails : currentData.expenseDetails;
        
        const pieOptions = {
            tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)', backgroundColor: 'rgba(20, 25, 38, 0.9)', borderColor: '#374151', textStyle: { color: '#f9fafb' } },
            legend: { show: false },
            series: [{
                name: type === 'income' ? '收入' : '支出',
                type: 'pie',
                radius: ['45%', '70%'],
                avoidLabelOverlap: false,
                itemStyle: {
                    borderRadius: 10,
                    borderColor: '#111827',
                    borderWidth: 2
                },
                label: { show: false, position: 'center' },
                emphasis: {
                    label: {
                        show: true,
                        fontSize: 20,
                        fontWeight: 'bold',
                        formatter: '{b}\n{d}%',
                        color: '#fff'
                    }
                },
                labelLine: { show: false },
                data: details.map(d => ({ name: d.name, value: d.value }))
            }],
            color: COLORS
        };
        
        pieChart.setOption(pieOptions);
        window.addEventListener('resize', () => pieChart.resize());
    }

    // --- 初始化應用程式 ---
    renderStatCards();
    renderMainCharts();
    renderAdvisor();
    renderMonthSelector();
    renderDetailsView();
});
</script>

</body>
</html>
